/*! cornerstone-lesion-tools - 0.1.0 - 2018-03-12 | (c) 2017 Chris Hafey | undefined */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("cornerstoneLesionTools",[],t):"object"==typeof exports?exports.cornerstoneLesionTools=t():e.cornerstoneLesionTools=t()}("undefined"!=typeof self?self:this,function(){return function(e){function t(n){if(r[n])return r[n].exports;var o=r[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var r={};return t.m=e,t.c=r,t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=4)}([function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=window.cornerstone,o=window.cornerstoneTools;t.default={set cornerstone(e){n=e},get cornerstone(){return n},set cornerstoneTools(e){o=e},get cornerstoneTools(){return o}}},function(e,t,r){"use strict";function n(e){var t=void 0,r=void 0,n=void 0,o=void 0;return Promise.all(e.map(function(a,i){return c.default.cornerstone.loadImage(a).then(function(a){if(!o){t=a.width,r=a.height;var u=t*r*e.length;o=new ArrayBuffer(u),n=new s.TYPED_ARRAY(o)}for(var l=a.intercept,c=a.slope,f=a.getPixelData(),d=t*r,p=0;p<d;p++){var h=f[p],v=h*c+l,m=v>=g.calciumThresholdHu?1:0;n[i*d+p]=m}})})).then(function(){return{buffer:o,width:t,height:r}})}function o(e){var t=void 0,r=p(e,s.TOOL_TYPE);return r&&r.data&&r.data.length?t=r.data[0]:(t={enabled:1,buffer:null,width:null,height:null,history:[],drawBuffer:null},d(e,s.TOOL_TYPE,t)),t}function a(e){var t=p(e,"stack");if(console.log("got stack",t),t&&t.data&&t.data.length){var r=t.data[0],a=o(e);console.log("ABOUT TO PERFORM"),n(r.imageIds).then(function(t){a.buffer=t.buffer,a.width=t.width,a.height=t.height,c.default.cornerstone.updateImage(e)})}}function i(){return g}function u(e){g=e}Object.defineProperty(t,"__esModule",{value:!0});var l=r(0),c=function(e){return e&&e.__esModule?e:{default:e}}(l),s=r(2),f=c.default.cornerstoneTools,d=f.addToolState,p=f.getToolState,g={historySize:4,layersAbove:1,layersBelow:1,historyPosition:0,toolRegionValue:2,calciumThresholdHu:"-",drawAlpha:1,regionColorsRGB:[[255,0,255],[246,193,91],[237,148,69],[230,103,49],[184,74,41],[106,58,45]],KVPToMultiplier:{150:1.06,140:1.04,130:1.02,120:1,110:.98,100:.96,90:.93,80:.89,70:.85},growIterationsPerChunk:2};g.calciumThresholdHuParsed=parseInt(g.calciumThresholdHu,10),t.default={threshold:a,getConfiguration:i,setConfiguration:u}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.TYPED_ARRAY=Uint8Array,t.TOOL_TYPE="regions"},function(e,t,r){"use strict";function n(e){var t=l(e,"regions"),r=t.data[0],n=r.buffer.slice();r.history.push(n),r.history.length>c.historySize&&r.history.shift()}function o(e){var t=l(e,"regions"),r=t.data[0];if(!(r.history.length<1)){var n=r.history.pop();r.buffer=n,u.default.cornerstone.updateImage(e)}}function a(){}Object.defineProperty(t,"__esModule",{value:!0}),t.createUndoStep=n,t.undo=o,t.redo=a;var i=r(0),u=function(e){return e&&e.__esModule?e:{default:e}}(i),l=u.default.cornerstoneTools.getToolState,c={}},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var o=r(0);Object.defineProperty(t,"external",{enumerable:!0,get:function(){return n(o).default}});var a=r(5);Object.defineProperty(t,"display",{enumerable:!0,get:function(){return n(a).default}});var i=r(1);Object.defineProperty(t,"threshold",{enumerable:!0,get:function(){return n(i).default}});var u=r(6);Object.defineProperty(t,"grow",{enumerable:!0,get:function(){return n(u).default}});var l=r(7);Object.defineProperty(t,"draw",{enumerable:!0,get:function(){return n(l).default}});var c=r(9);Object.defineProperty(t,"score",{enumerable:!0,get:function(){return n(c).default}});var s=r(3);Object.defineProperty(t,"undo",{enumerable:!0,get:function(){return s.undo}}),Object.defineProperty(t,"redo",{enumerable:!0,get:function(){return s.redo}})},function(e,t,r){"use strict";function n(e){var t=e.detail,r=t.canvasContext,n=t.element,o=t.enabledElement,u=t.image,l=u.width,f=u.height,d=c(n,"stack"),p=c(n,"regions");if(p&&p.data&&p.data.length){if(!p.data[0].drawBuffer||l!==p.data[0].drawBuffer.canvas.width){var g=document.createElement("canvas"),h=g.getContext("2d"),v=h.createImageData(l,f);g.width=l,g.height=f,p.data[0].drawBuffer={canvas:g,imageData:v}}for(var m=d.data[0].currentImageIdIndex,y=p.data[0],b=y.drawBuffer,w=y.buffer,T=b.canvas,P=b.imageData,x=P.data,O=l*f,_=m*O,M=new i.TYPED_ARRAY(w,_,O),S=0;S<M.length;S+=1){var j=4*S,A=M[S];if(A){var E=s.regionColorsRGB[A-1];x[j+0]=E[0],x[j+1]=E[1],x[j+2]=E[2],x[j+3]=255*s.drawAlpha}else x[j+3]=0}T.getContext("2d").putImageData(P,0,0),a.default.cornerstone.setToPixelCoordinateSystem(o,r),r.drawImage(T,0,0)}}Object.defineProperty(t,"__esModule",{value:!0});var o=r(0),a=function(e){return e&&e.__esModule?e:{default:e}}(o),i=r(2),u=a.default.cornerstoneTools,l=u.displayTool,c=u.getToolState,s={drawAlpha:1,regionColorsRGB:[[255,0,255],[246,193,91],[237,148,69],[230,103,49],[184,74,41],[106,58,45]]},f=l(n);f.setConfiguration(s),t.default=f},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function o(e,t,r,n,o){var a=e*t,i=[o-1,o+1,o-e,o+e],u=Math.floor(o/a);return u<r&&i.push(o+a),u>n&&i.push(o-a),i}function a(e,t){var r=d.default.getConfiguration(),n=r.growIterationsPerChunk,a=r.toolRegionValue,i=r.layersAbove,l=r.layersBelow,c=e.width,s=e.height,f=e.buffer,p=u(t,3),g=p[0],h=p[1],v=p[2],m=v+l,y=v-i,b=new Uint8Array(f),w=c*s,T=w*v,P=h*c+g,x=T+P,O=b[x];if(0===O||O===a)return Promise.resolve();var _=[x];return new Promise(function(e){function t(){for(var r=0;r<n;r++){if(0===_.length)return e();_.forEach(function(e){b[e]=a});var i=_.map(function(e){return o(c,s,m,y,e)}).reduce(function(e,t){return e.concat(t)},[]).filter(function(e,t,r){return r.indexOf(e)===t}).filter(function(e){return b[e]===O});_=i}setTimeout(t,0)}t()})}function i(e){var t=e.detail,r=t.currentPoints,n=t.element,o=t.which,i=m(y,n);if(v(o,i.mouseButtonMask)){var l=u(g(n,"stack").data,1),f=l[0],d=u(g(n,"regions").data,1),p=d[0],h=f.currentImageIdIndex,b=r.image,w=b.x,T=b.y,P=[Math.round(w),Math.round(T),h];(0,s.createUndoStep)(n),a(p,P).then(function(){c.default.cornerstone.updateImage(n)})}}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){var r=[],n=!0,o=!1,a=void 0;try{for(var i,u=e[Symbol.iterator]();!(n=(i=u.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{!n&&u.return&&u.return()}finally{if(o)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),l=r(0),c=n(l),s=r(3),f=r(1),d=n(f),p=c.default.cornerstoneTools,g=p.getToolState,h=p.simpleMouseButtonTool,v=p.isMouseButtonEnabled,m=p.getToolOptions,y="regionsGrow",b=h(i,y);t.default=b},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function o(e){var t=h.default.getConfiguration(),r=t.toolRegionValue,n=t.layersAbove,o=t.layersBelow;(0,f.createUndoStep)(e);var a=m(e,"stack"),i=m(e,"regions"),u=y(P,e),l=a.data[0].currentImageIdIndex,c=a.data[0].imageIds.length,s=i.data[0],d=u.points.map(function(e){return[e.x,e.y]}),g=s.buffer,v=s.width,b=s.height,w=Math.max(0,l-n),T=Math.min(c,l+o),O=v*b,_=w*O,M=new Uint8Array(g,_);console.log(c);for(var S=0;S<=T-w;S+=1)for(var j=0;j<v;j+=1)for(var A=0;A<b;A+=1){var E=j+A*v+S*O,I=M[E],C=void 0;C=!x.snap||I>0,C&&(0,p.default)([j,A],d)&&(M[E]=r)}}function a(e){var t=e.detail,r=t.canvasContext,n=t.enabledElement,o=t.element,a=O.getConfiguration(),i=a.fillStyle,u=a.strokeStyle,l=y(P,o),c=l.points;c.length<2||(s.default.cornerstone.setToPixelCoordinateSystem(n,r),r.fillStyle=i,r.strokeStyle=u,r.beginPath(),r.moveTo(c[0].x,c[0].y),c.slice(1).forEach(function(e){r.lineTo(e.x,e.y)}),r.closePath(),r.stroke(),r.fill())}function i(e){var t=e.detail,r=t.currentPoints,n=t.element;y(P,n).points.push(r.image),s.default.cornerstone.updateImage(n),e.preventDefault(),e.stopPropagation()}function u(e){var t=e.detail.element;t.removeEventListener("cornerstonetoolsmousedrag",i),t.removeEventListener("cornerstonetoolsmouseup",u),t.removeEventListener("cornerstonetoolsmouseclick",u),t.removeEventListener("cornerstoneimagerendered",a),o(t),s.default.cornerstone.updateImage(t)}function l(e){var t=e.detail,r=t.element,n=t.which,o=y(P,r);T(n,o.mouseButtonMask)&&(o.points=[],b(P,r,o),r.addEventListener("cornerstonetoolsmousedrag",i),r.addEventListener("cornerstonetoolsmouseup",u),r.addEventListener("cornerstonetoolsmouseclick",u),r.addEventListener("cornerstoneimagerendered",a),e.preventDefault(),e.stopPropagation())}Object.defineProperty(t,"__esModule",{value:!0});var c=r(0),s=n(c),f=r(3),d=r(8),p=n(d),g=r(1),h=n(g),v=s.default.cornerstoneTools,m=v.getToolState,y=v.getToolOptions,b=v.setToolOptions,w=v.simpleMouseButtonTool,T=v.isMouseButtonEnabled,P="draw",x={snap:!1,fillStyle:"rgba(255,255,255,.2)",strokeStyle:"white"},O=w(l,P);O.getConfiguration=function(){return x},O.setConfiguration=function(e){x=e},t.default=O},function(e,t,r){"use strict";function n(e,t){for(var r=o(e,2),n=r[0],a=r[1],i=!1,u=0,l=t.length-1;u<t.length;l=u++){var c=o(t[u],2),s=c[0],f=c[1],d=o(t[l],2),p=d[0],g=d[1];f>a!=g>a&&n<(p-s)*(a-f)/(g-f)+s&&(i=!i)}return i}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){var r=[],n=!0,o=!1,a=void 0;try{for(var i,u=e[Symbol.iterator]();!(n=(i=u.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{!n&&u.return&&u.return()}finally{if(o)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();t.default=n},function(e,t,r){"use strict";function n(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function o(e){return e<130?0:e<200?1:e<300?2:e<400?3:4}function a(e){if(0===e.length)return null;for(var t={},r=e[0],n=1,o=0;o<e.length;o++){var a=e[o];null===t[a]?t[a]=1:t[a]++,t[a]>n&&(r=a,n=t[a])}return r}function i(e){if(0===e.sliceThickness||0===e.pixelSpacing[0]||0===e.pixelSpacing[1])throw new Error("sliceThickness or pixelSpacing was 0");return e.sliceThickness*e.pixelSpacing[0]*e.pixelSpacing[1]}function u(e,t){var r=i(e)/3,n=o(e.maxHU),a=t.length*r,u=(0,h.getConfiguration)(),l=u.KVPToMultiplier,c=l[e.KVP],s=a*n*c;return console.log("modeOverlapFactor: "+e.modeOverlapFactor),console.log("voxels.length: "+t.length),console.log("voxelSizeScaled: "+r),console.log("Volume: "+a),console.log("Max HU: "+e.maxHU),console.log("densityFactor: "+n),console.log("KVPMultiplier: "+c),console.log("CAscore: "+s),e.modeOverlapFactor?s*e.modeOverlapFactor:s}function l(e,t){var r=new g.default.cornerstoneMath.Vector3;r.fromArray(e[0]);var n=new g.default.cornerstoneMath.Vector3;n.fromArray(e[1]);var o=new g.default.cornerstoneMath.Vector3;o.fromArray(t[0]);var a=new g.default.cornerstoneMath.Vector3;a.fromArray(t[1]);var i=new g.default.cornerstoneMath.Vector3;i.crossVectors(o,a);var u=r.projectOnVector(i),l=n.projectOnVector(i);return u.distanceTo(l)}function c(e,t){if(e<=0)throw new Error("Distance must be > 0");return e>=t?1:(t-(t-e))/t}function s(e,t,r,n,o,a){for(var i=a.intercept,u=a.slope,l=a.width,c=a.getPixelData(),s=[],f=[[e,t]];f.length>0;){var p=f.shift(),g=d(p,2),h=g[0],v=g[1];if(0===n[h][v]&&r[v*l+h]===o){f.push([h-1,v]),f.push([h+1,v]),f.push([h,v-1]),f.push([h,v+1]);var m=c[h+v*l],y=m*u+i;y>=130&&s.push(y),n[h][v]=1}}return s}function f(){var e=(0,h.getLastElement)(),t=(0,h.getConfiguration)(),r=t.regionColorsRGB,o=m(e,v.TOOL_TYPE),i=m(e,"stack"),f=o.data[0].buffer,d=i.data[0].imageIds,p=r.slice(1).map(function(){return d.map(function(){return[]})}),y=r.slice(1).map(function(){return d.map(function(){return[]})}),b=void 0,w=void 0,T=[],P={};return Promise.all(d.map(function(e,t){return g.default.cornerstone.loadImage(e).then(function(e){var r=e.data;P.sliceThickness=r.floatString("x00180050"),P.pixelSpacing=r.string("x00280030").split("\\").map(parseFloat),P.KVP=r.floatString("x00180060"),P.rescaleSlope=r.floatString("x00281053"),P.rescaleIntercept=r.floatString("x00281052"),P.rescaleType=r.string("x00281054");var o=r.string("x00200032").split("\\").map(parseFloat),i=r.string("x00200037").split("\\").map(parseFloat),u=[i.slice(0,3),i.slice(3)];if(w){var d=l([w,o],u);b=c(d,P.sliceThickness),T.push(b),P.modeOverlapFactor=a(T),w=o}else w=o;for(var g=e.height,h=e.width,m=h*g,x=t*m,O=new v.TYPED_ARRAY(f,x,m),_=Array(h).fill().map(function(){return Array(g).fill(0)}),M=0;M<h;M+=1)for(var S=0;S<g;S+=1){var j=O[S*h+M];if(j>1){var A=s(M,S,O,_,j,e);if(A.length){var E=Math.max.apply(Math,n(A));p[j-2][t].push(A),y[j-2][t].push(E)}}}})})).then(function(){return p.map(function(e,t){var r=[];return e.forEach(function(e,n){e.forEach(function(e,o){P.maxHU=y[t][n][o];var a=e.length>0?u(P,e):0;r.push(a)})}),r.reduce(function(e,t){return e+t},0)})})}Object.defineProperty(t,"__esModule",{value:!0});var d=function(){function e(e,t){var r=[],n=!0,o=!1,a=void 0;try{for(var i,u=e[Symbol.iterator]();!(n=(i=u.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{!n&&u.return&&u.return()}finally{if(o)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();t.computeVoxelSize=i,t.computeScore=u,t.computeIOPProjectedDistance=l,t.computeOverlapFactor=c,t.score=f;var p=r(0),g=function(e){return e&&e.__esModule?e:{default:e}}(p),h=r(1),v=r(2),m=g.default.cornerstoneTools.getToolState;t.default=f}])});
//# sourceMappingURL=cornerstoneLesionTools.min.js.map