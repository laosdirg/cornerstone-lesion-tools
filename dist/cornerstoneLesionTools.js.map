{"version":3,"sources":["webpack:///webpack/universalModuleDefinition","webpack:///webpack/bootstrap 1d85526556d12a1233f5","webpack:///./externalModules.js","webpack:///./configuration.js","webpack:///./constants.js","webpack:///./lesionTools/history.js","webpack:///./index.js","webpack:///./lesionTools/display.js","webpack:///./lesionTools/threshold.js","webpack:///./lesionTools/grow.js","webpack:///./lesionTools/draw.js","webpack:///./util/pointInsidePolygon.js","webpack:///./lesionTools/score.js"],"names":["cornerstoneTools","window","cst","cornerstone","external","cornerstoneMath","getConfiguration","setConfiguration","configuration","snap","historySize","layersAbove","layersBelow","historyPosition","toolRegionValue","calciumThresholdHu","drawAlpha","regionColorsRGB","KVPToMultiplier","growIterationsPerChunk","calciumThresholdHuParsed","parseInt","config","console","log","TYPED_ARRAY","Uint8Array","TOOL_TYPE","createUndoStep","undo","redo","getToolState","element","thresholdingData","state","data","current","buffer","slice","history","push","length","shift","replacement","pop","updateImage","default","displayTool","onImageRendered","detail","canvasContext","enabledElement","image","width","height","stackToolData","regionsToolData","drawBuffer","canvas","document","createElement","context","getContext","imageData","createImageData","currentImageIdIndex","doubleBuffer","pixels","sliceSize","sliceOffset","view","offset","imageDataOffset","label","color","putImageData","setToPixelCoordinateSystem","drawImage","lesionIndicator","addToolState","performThresholding","imageIds","Promise","all","map","imageId","imageIdIndex","loadImage","then","ArrayBuffer","intercept","slope","pixelData","getPixelData","i","value","hu","ensureToolData","regionsData","enabled","threshold","stackData","regions","simpleMouseButtonTool","isMouseButtonEnabled","getToolOptions","toolType","linearNeighbours","highSlice","lowSlice","index","neighbours","sliceIndex","Math","floor","regionGrowing","point","x","y","clickIndex","linearIndex","fromValue","resolve","activeVoxels","chunk","forEach","nextVoxels","reduce","acc","cur","concat","filter","self","indexOf","setTimeout","mouseDownCallback","e","currentPoints","which","options","mouseButtonMask","round","toolColors","setToolOptions","updateRegions","numSlices","startSlice","max","endSlice","min","dslice","prevValue","snapBool","points","imageRenderedCallback","fillStyle","getFillColor","strokeStyle","getActiveColor","beginPath","moveTo","lineTo","closePath","stroke","fill","dragCallback","preventDefault","stopPropagation","mouseUpCallback","removeEventListener","addEventListener","pointInsidePolygon","polygon","n","inside","j","xi","yi","xj","yj","intersect","computeVoxelSize","computeScore","computeIOPProjectedDistance","computeOverlapFactor","score","getDensityFactor","mode","array","modeMap","maxEl","maxCount","el","metaData","sliceThickness","pixelSpacing","Error","zLength","xLength","yLength","voxels","voxelSizeScaled","densityFactor","maxHU","volume","KVPMultiplier","KVP","cascore","modeOverlapFactor","imagePositions","imageOrientation","imagePosition1Vector","Vector3","fromArray","imagePosition2Vector","imageOrientationRowVector","imageOrientationColumnVector","orientationNormal","crossVectors","projection1","projectOnVector","projection2","distanceTo","distance","overlap","bfs","visitedVoxels","lesionVoxels","stack","voxelsEachRegion","maxHUEachRegion","overlapFactor","prevImagePosition","overlapFactors","imageIndex","dataSet","floatString","string","split","parseFloat","rescaleSlope","rescaleIntercept","rescaleType","imagePositionPatient","imageOrientationTmp","Array","slicesInLabel","labelIdx","lesions","sliceIdx","lesionIdx","cascoreCurrent","sum","val"],"mappings":"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","file":"cornerstoneLesionTools.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine(\"cornerstoneLesionTools\", [], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"cornerstoneLesionTools\"] = factory();\n\telse\n\t\troot[\"cornerstoneLesionTools\"] = factory();\n})(typeof self !== 'undefined' ? self : this, function() {\nreturn \n\n\n// WEBPACK FOOTER //\n// webpack/universalModuleDefinition"," \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 4);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 1d85526556d12a1233f5","let cornerstoneTools = window.cornerstoneTools;\n\nexport default {\n  set cornerstoneTools (cst) {\n    cornerstoneTools = cst;\n  },\n  get cornerstoneTools () {\n    return cornerstoneTools;\n  },\n  get cornerstone () {\n    return cornerstoneTools.external.cornerstone;\n  },\n  get cornerstoneMath () {\n    return cornerstoneTools.external.cornerstoneMath;\n  }\n};\n\n\n\n// WEBPACK FOOTER //\n// ./externalModules.js","let configuration = {\n  snap: false, // Snap to thresholded region or not\n  historySize: 4,\n  layersAbove: 1,\n  layersBelow: 1,\n  historyPosition: 0,\n  toolRegionValue: 2,\n  calciumThresholdHu: '-', // Placeholder until it gets set ('-' shows up nicely in text input)\n  drawAlpha: 1,\n  regionColorsRGB: [\n    [255, 0, 255],\n    [246, 193, 91],\n    [237, 148, 69],\n    [230, 103, 49],\n    [184, 74, 41],\n    [106, 58, 45]\n  ],\n  KVPToMultiplier: {\n    150: 1.06,\n    140: 1.04,\n    130: 1.02,\n    120: 1,\n    110: 0.98,\n    100: 0.96,\n    90: 0.93,\n    80: 0.89,\n    70: 0.85\n  },\n  growIterationsPerChunk: 2\n};\n\nconfiguration.calciumThresholdHuParsed = parseInt(configuration.calciumThresholdHu, 10);\n\nexport function getConfiguration () {\n  return configuration;\n}\n\nexport function setConfiguration (config) {\n  console.log(\"c\", config);\n  configuration = config;\n}\n\n\n\n// WEBPACK FOOTER //\n// ./configuration.js","export const TYPED_ARRAY = Uint8Array;\nexport const TOOL_TYPE = 'regions';\n\n\n\n// WEBPACK FOOTER //\n// ./constants.js","import external from '../externalModules.js';\nimport { getConfiguration } from '../configuration.js';\n\nconst { getToolState } = external.cornerstoneTools;\n\n/**\n * Store current state to history\n */\nexport function createUndoStep (element) {\n  const thresholdingData = getToolState(element, 'regions');\n\n  const state = thresholdingData.data[0];\n  // Make a copy using .slice()\n  const current = state.buffer.slice();\n\n  // Put at end of history\n  state.history.push(current);\n  // Remove oldest if too much history\n  if (state.history.length > getConfiguration().historySize) {\n    state.history.shift();\n  }\n}\n\nexport function undo (element) {\n  const thresholdingData = getToolState(element, 'regions');\n  const state = thresholdingData.data[0];\n\n  if (state.history.length < 1) {\n    return;\n  }\n\n  const replacement = state.history.pop();\n\n  state.buffer = replacement;\n  external.cornerstone.updateImage(element);\n}\n\nexport function redo () {\n  // Not implemented\n}\n\n\n\n// WEBPACK FOOTER //\n// ./lesionTools/history.js","export { default as external } from './externalModules.js';\nexport { getConfiguration, setConfiguration } from './configuration.js';\n\nexport { default as display } from './lesionTools/display.js';\nexport { default as threshold } from './lesionTools/threshold.js';\nexport { default as grow } from './lesionTools/grow.js';\nexport { default as draw } from './lesionTools/draw.js';\nexport { default as score } from './lesionTools/score.js';\nexport { undo, redo } from './lesionTools/history.js';\n\n\n\n// WEBPACK FOOTER //\n// ./index.js","import external from '../externalModules.js';\nimport { TYPED_ARRAY } from '../constants.js';\nimport { getConfiguration } from '../configuration.js';\n\nconst { displayTool, getToolState } = external.cornerstoneTools;\n\n/**\n * Draw regions on image\n */\nfunction onImageRendered ({ detail }) {\n  const configuration = getConfiguration();\n  const { canvasContext, element, enabledElement, image } = detail;\n  const { width, height } = image;\n\n  const stackToolData = getToolState(element, 'stack');\n  const regionsToolData = getToolState(element, 'regions');\n\n  // Ensure tool is enabled\n  if (!regionsToolData || !regionsToolData.data || !regionsToolData.data.length) {\n    return;\n  }\n\n  if (!regionsToolData.data[0].drawBuffer || width !== regionsToolData.data[0].drawBuffer.canvas.width) {\n    const canvas = document.createElement('canvas');\n    const context = canvas.getContext('2d');\n    const imageData = context.createImageData(width, height);\n\n    canvas.width = width;\n    canvas.height = height;\n\n    regionsToolData.data[0].drawBuffer = {\n      canvas,\n      imageData\n    };\n  }\n\n  // Extract tool data\n  const { currentImageIdIndex } = stackToolData.data[0];\n  const { drawBuffer, buffer } = regionsToolData.data[0];\n\n  const doubleBuffer = drawBuffer.canvas;\n  const imageData = drawBuffer.imageData;\n\n  const pixels = imageData.data;\n  const sliceSize = width * height;\n  const sliceOffset = currentImageIdIndex * sliceSize;\n  const view = new TYPED_ARRAY(buffer, sliceOffset, sliceSize);\n\n  for (let offset = 0; offset < view.length; offset += 1) {\n    // Each pixel is represented by four elements in the imageData array\n    const imageDataOffset = offset * 4;\n    const label = view[offset];\n\n    if (label) {\n      const color = configuration.regionColorsRGB[label - 1];\n\n      pixels[imageDataOffset + 0] = color[0];\n      pixels[imageDataOffset + 1] = color[1];\n      pixels[imageDataOffset + 2] = color[2];\n      pixels[imageDataOffset + 3] = configuration.drawAlpha * 255;\n    } else {\n      pixels[imageDataOffset + 3] = 0;\n    }\n  }\n\n  // Put image data back into offscreen canvas\n  doubleBuffer.getContext('2d').putImageData(imageData, 0, 0);\n  // Set transforms based on zoom/pan/etc\n  external.cornerstone.setToPixelCoordinateSystem(enabledElement, canvasContext);\n  // Finally, draw offscreen canvas onto context\n  canvasContext.drawImage(doubleBuffer, 0, 0);\n}\n\nconst lesionIndicator = displayTool(onImageRendered);\n\nexport default lesionIndicator;\n\n\n\n// WEBPACK FOOTER //\n// ./lesionTools/display.js","import external from '../externalModules.js';\nimport { TYPED_ARRAY, TOOL_TYPE } from '../constants.js';\nimport { getConfiguration } from '../configuration.js';\n\nconst { addToolState, getToolState } = external.cornerstoneTools;\n\n/**\n * Perform the thresholding on a stack\n */\nfunction performThresholding (imageIds) {\n  let width, height, view, buffer;\n\n  const configuration = getConfiguration();\n\n  // Thresholding promises\n  return Promise.all(imageIds.map((imageId, imageIdIndex) =>\n    external.cornerstone.loadImage(imageId).then((image) => {\n      if (!buffer) {\n        // Initialize variables on first loaded image\n        width = image.width;\n        height = image.height;\n\n        const length = width * height * imageIds.length;\n\n        buffer = new ArrayBuffer(length);\n        view = new TYPED_ARRAY(buffer);\n      }\n\n      const { intercept, slope } = image;\n      const pixelData = image.getPixelData();\n      const sliceSize = width * height;\n\n      for (let i = 0; i < sliceSize; i++) {\n        const value = pixelData[i];\n        // Calculate hu-value\n        const hu = (value * slope) + intercept;\n        // Check against threshold\n        const label = (hu >= configuration.calciumThresholdHu) ? 1 : 0;\n        // Calculate offset within view into ArrayBufer\n        const offset = imageIdIndex * sliceSize + i;\n\n        // Finally, assign label\n        view[offset] = label;\n      }\n    })\n  // When all promises resolve, return the buffer and its dimensions\n  )).then(() => ({\n    buffer,\n    width,\n    height\n  }));\n}\n\nfunction ensureToolData (element) {\n  let regionsData;\n\n  const regionsToolData = getToolState(element, TOOL_TYPE);\n\n  if (!regionsToolData || !regionsToolData.data || !regionsToolData.data.length) {\n    regionsData = {\n      enabled: 1,\n      buffer: null,\n      width: null,\n      height: null,\n      history: [],\n      drawBuffer: null\n    };\n    addToolState(element, TOOL_TYPE, regionsData);\n  } else {\n    regionsData = regionsToolData.data[0];\n  }\n\n  return regionsData;\n}\n\nfunction threshold (element) {\n  const stackToolData = getToolState(element, 'stack');\n\n  if (!stackToolData || !stackToolData.data || !stackToolData.data.length) {\n    return;\n  }\n\n  const stackData = stackToolData.data[0];\n  const regionsData = ensureToolData(element);\n\n  performThresholding(stackData.imageIds).then((regions) => {\n    // Add threshold data to tool state\n    regionsData.buffer = regions.buffer;\n    regionsData.width = regions.width;\n    regionsData.height = regions.height;\n\n    // Update the element to apply the viewport and tool changes\n    external.cornerstone.updateImage(element);\n  });\n}\n// Module/private exports\nexport default threshold;\n\n\n\n// WEBPACK FOOTER //\n// ./lesionTools/threshold.js","import external from '../externalModules.js';\nimport { createUndoStep } from './history.js';\nimport { getConfiguration } from '../configuration.js';\n\nconst {\n  getToolState,\n  simpleMouseButtonTool,\n  isMouseButtonEnabled,\n  getToolOptions\n} = external.cornerstoneTools;\n\nconst toolType = 'regionsGrow';\n\n// Get neighbour linear indices within slice bounds\nfunction linearNeighbours (width, height, highSlice, lowSlice, index) {\n  const sliceSize = width * height;\n  const neighbours = [\n    index - 1,\n    index + 1,\n    index - width,\n    index + width\n  ];\n\n  // Stay within bounds\n  const sliceIndex = Math.floor(index / sliceSize);\n\n  if (sliceIndex < highSlice) {\n    neighbours.push(index + sliceSize);\n  }\n  if (sliceIndex > lowSlice) {\n    neighbours.push(index - sliceSize);\n  }\n\n  return neighbours;\n}\n\nfunction regionGrowing (regions, point) {\n  const { growIterationsPerChunk, toolRegionValue, layersAbove, layersBelow } = getConfiguration();\n  const { width, height, buffer } = regions;\n  const [x, y, slice] = point;\n  const highSlice = slice + layersBelow;\n  const lowSlice = slice - layersAbove;\n\n  const view = new Uint8Array(buffer);\n\n  // Calculate linear indices and offsets\n  const sliceSize = width * height;\n  const sliceOffset = sliceSize * slice;\n  const clickIndex = (y * width) + x;\n  const linearIndex = sliceOffset + clickIndex;\n  const fromValue = view[linearIndex];\n\n  // Only continue if we clicked in thresholded area in different color\n  if (fromValue === 0 || fromValue === toolRegionValue) {\n    return Promise.resolve();\n  }\n\n  // Growing starts at clicked voxel\n  let activeVoxels = [linearIndex];\n\n  return new Promise((resolve) => {\n    function chunk () {\n      for(let i = 0; i < growIterationsPerChunk; i++) {\n        // While activeVoxels is not empty\n        if (activeVoxels.length === 0) {\n          return resolve();\n        }\n\n        // Set the active voxels to nextValue\n        activeVoxels.forEach((i) => {\n          view[i] = toolRegionValue;\n        });\n\n        // The new active voxels are neighbours of curent active voxels\n        const nextVoxels = activeVoxels.map(\n          (i) => linearNeighbours(width, height, highSlice, lowSlice, i)\n        ).reduce( // Flatten the array of arrays to array of indices\n          (acc, cur) => acc.concat(cur), []\n        ).filter( // Remove duplicates\n          (value, index, self) => self.indexOf(value) === index\n        ).filter( // Remove voxels that does not have the correct fromValue\n          (i) => view[i] === fromValue\n        );\n\n        activeVoxels = nextVoxels;\n      }\n      setTimeout(chunk, 0);\n    }\n\n    chunk();\n  });\n}\n\nfunction mouseDownCallback (e) {\n  const { currentPoints, element, which } = e.detail;\n  const options = getToolOptions(toolType, element);\n\n  if (isMouseButtonEnabled(which, options.mouseButtonMask)) {\n    const [stackData] = getToolState(element, 'stack').data;\n    const [regionsData] = getToolState(element, 'regions').data;\n    const { currentImageIdIndex } = stackData;\n    const { x, y } = currentPoints.image;\n    const point = [Math.round(x), Math.round(y), currentImageIdIndex];\n\n    createUndoStep(element);\n    regionGrowing(regionsData, point).then(() => {\n      external.cornerstone.updateImage(element);\n    });\n  }\n}\n\nexport default simpleMouseButtonTool(mouseDownCallback, toolType);\n\n\n\n// WEBPACK FOOTER //\n// ./lesionTools/grow.js","import external from '../externalModules.js';\nimport pointInsidePolygon from '../util/pointInsidePolygon.js';\nimport { getConfiguration } from '../configuration.js';\n\nimport { createUndoStep } from './history.js';\n\nconst { toolColors, getToolState, getToolOptions, setToolOptions, simpleMouseButtonTool, isMouseButtonEnabled } = external.cornerstoneTools;\n\nconst toolType = 'draw';\n\nfunction updateRegions (element) {\n  const { snap, toolRegionValue, layersAbove, layersBelow } = getConfiguration();\n\n  createUndoStep(element);\n\n  // Get tool data\n  const stackData = getToolState(element, 'stack');\n  const thresholdingData = getToolState(element, 'regions');\n  const options = getToolOptions(toolType, element);\n\n  // Extract tool data\n  const slice = stackData.data[0].currentImageIdIndex;\n  const numSlices = stackData.data[0].imageIds.length;\n  const regions = thresholdingData.data[0];\n\n  // Extract region data\n  const buffer = regions.buffer;\n  const width = regions.width;\n  const height = regions.height;\n\n  // Find operation bounds\n  const startSlice = Math.max(0, slice - layersAbove);\n  const endSlice = Math.min(numSlices, slice + layersBelow);\n\n  // Setup view into buffer\n  const sliceSize = width * height;\n  const sliceOffset = startSlice * sliceSize;\n  const view = new Uint8Array(buffer, sliceOffset);\n\n  // Mark points inside\n  for (let dslice = 0; dslice <= endSlice - startSlice; dslice += 1) {\n    for (let x = 0; x < width; x += 1) {\n      for (let y = 0; y < height; y += 1) {\n        const index = x + (y * width) + (dslice * sliceSize);\n        const prevValue = view[index];\n\n        let snapBool;\n\n        if (snap) {\n          snapBool = prevValue > 0;\n        } else {\n          snapBool = true;\n        }\n        const point = {\n          x,\n          y\n        };\n\n        if (snapBool && pointInsidePolygon(point, options.points)) {\n          view[index] = toolRegionValue;\n        }\n      }\n    }\n  }\n}\n\n// Draw regions on the canvas\nfunction imageRenderedCallback (e) {\n  const { canvasContext, enabledElement, element } = e.detail;\n\n  // Points\n  const options = getToolOptions(toolType, element);\n  const points = options.points;\n\n  if (points.length < 2) {\n    return;\n  }\n\n  // Set the canvas context to the image coordinate system\n  external.cornerstone.setToPixelCoordinateSystem(enabledElement, canvasContext);\n\n  canvasContext.fillStyle = toolColors.getFillColor();\n  canvasContext.strokeStyle = toolColors.getActiveColor();\n  canvasContext.beginPath();\n  canvasContext.moveTo(points[0].x, points[0].y);\n  points.slice(1).forEach(function (point) {\n    canvasContext.lineTo(point.x, point.y);\n  });\n  canvasContext.closePath();\n  canvasContext.stroke();\n  canvasContext.fill();\n}\n\nfunction dragCallback (e) {\n  const { currentPoints, element } = e.detail;\n  const options = getToolOptions(toolType, element);\n\n  options.points.push(currentPoints.image);\n  external.cornerstone.updateImage(element);\n\n  e.preventDefault();\n  e.stopPropagation();\n}\n\n// Disable drawing and tracking on mouse up also update regions\nfunction mouseUpCallback (e) {\n  const { element } = e.detail;\n\n  element.removeEventListener('cornerstonetoolsmousedrag', dragCallback);\n  element.removeEventListener('cornerstonetoolsmouseup', mouseUpCallback);\n  element.removeEventListener('cornerstonetoolsmouseclick', mouseUpCallback);\n  element.removeEventListener('cornerstoneimagerendered', imageRenderedCallback);\n\n  updateRegions(element);\n  external.cornerstone.updateImage(element);\n}\n\n// Start drawing and tracking on mouse up, also reset points array\nfunction mouseDownCallback (e) {\n  const { element, which } = e.detail;\n  const options = getToolOptions(toolType, element);\n\n  if (isMouseButtonEnabled(which, options.mouseButtonMask)) {\n    options.points = [];\n\n    setToolOptions(toolType, element, options);\n\n    element.addEventListener('cornerstonetoolsmousedrag', dragCallback);\n    element.addEventListener('cornerstonetoolsmouseup', mouseUpCallback);\n    element.addEventListener('cornerstonetoolsmouseclick', mouseUpCallback);\n    element.addEventListener('cornerstoneimagerendered', imageRenderedCallback);\n\n    e.preventDefault();\n    e.stopPropagation();\n  }\n}\n\nexport default simpleMouseButtonTool(mouseDownCallback, toolType);\n\n\n\n// WEBPACK FOOTER //\n// ./lesionTools/draw.js","// Determine if a point is inside a polygon\nexport default function pointInsidePolygon (point, polygon) {\n  const { x, y } = point;\n  const n = polygon.length;\n  let inside = false;\n\n  for (let i = 0, j = n - 1; i < n; j = i++) {\n    const { x: xi, y: yi } = polygon[i];\n    const { x: xj, y: yj } = polygon[j];\n\n    const intersect = ((yi > y) !== (yj > y)) &&\n      (x < (xj - xi) * (y - yi) / (yj - yi) + xi);\n\n    if (intersect) {\n      inside = !inside;\n    }\n  }\n\n  return inside;\n}\n\n\n\n// WEBPACK FOOTER //\n// ./util/pointInsidePolygon.js","import external from '../externalModules.js';\nimport { getConfiguration } from '../configuration.js';\nimport { TYPED_ARRAY, TOOL_TYPE } from '../constants.js';\n\nconst { getToolState } = external.cornerstoneTools;\n\nfunction getDensityFactor (hu) {\n  if (hu < 130) {\n    return 0;\n  } else if (hu < 200) {\n    return 1;\n  } else if (hu < 300) {\n    return 2;\n  } else if (hu < 400) {\n    return 3;\n  }\n\n  return 4;\n}\n\n// Finds the value with the most occurrences in array\n// Should be O(n)\nfunction mode (array) {\n  if (array.length === 0) {\n    return null;\n  }\n  const modeMap = {};\n  let maxEl = array[0];\n  let maxCount = 1;\n\n  for (let i = 0; i < array.length; i++) {\n    const el = array[i];\n\n    if (modeMap[el] === null) {\n      modeMap[el] = 1;\n    } else {\n      modeMap[el]++;\n    }\n\n    if(modeMap[el] > maxCount) {\n      maxEl = el;\n      maxCount = modeMap[el];\n    }\n  }\n\n  return maxEl;\n}\n\nexport function computeVoxelSize (metaData) {\n  if (metaData.sliceThickness === 0 ||\n      metaData.pixelSpacing[0] === 0 ||\n      metaData.pixelSpacing[1] === 0) {\n    throw new Error('sliceThickness or pixelSpacing was 0');\n  }\n  const zLength = metaData.sliceThickness;\n  const xLength = metaData.pixelSpacing[0];\n  const yLength = metaData.pixelSpacing[1];\n\n\n  return zLength * xLength * yLength; // In mm³\n}\n\nexport function computeScore (metaData, voxels) {\n  // Division by 3 because Agatson score assumes a slice thickness of 3 mm\n  const voxelSizeScaled = computeVoxelSize(metaData) / 3;\n  const densityFactor = getDensityFactor(metaData.maxHU);\n  const volume = voxels.length * voxelSizeScaled;\n\n  const { KVPToMultiplier } = getConfiguration();\n  const KVPMultiplier = KVPToMultiplier[metaData.KVP];\n  const cascore = volume * densityFactor * KVPMultiplier;\n\n /*\n  console.log(`modeOverlapFactor: ${metaData.modeOverlapFactor}`);\n  console.log(`voxels.length: ${voxels.length}`);\n  console.log(`voxelSizeScaled: ${voxelSizeScaled}`);\n  console.log(`Volume: ${volume}`);\n  console.log(`Max HU: ${metaData.maxHU}`);\n  console.log(`densityFactor: ${densityFactor}`);\n  console.log(`KVPMultiplier: ${KVPMultiplier}`);\n  console.log(`CAscore: ${cascore}`); */\n\n  // If modeOverlapFactor factor is undefined it is because there is only one slice in the series.\n  // In this case obviously modeOverlapFactor is meaningless and should not be multiplied with cascore.\n  if (metaData.modeOverlapFactor) {\n    return cascore * metaData.modeOverlapFactor;\n  }\n\n  return cascore;\n\n}\n\n/*\n* Computes the distance between two slices based on the DICOM Image Plane Module\n* @param imagePositions {Array[2][3]} - DICOM tag (0020, 0032) of two slices\n* @param imageOrientation {Array[2][3]} - DICOM tag (0020, 0037) of first slice\n*/\nexport function computeIOPProjectedDistance (imagePositions, imageOrientation) {\n  const imagePosition1Vector = new external.cornerstoneMath.Vector3();\n\n  imagePosition1Vector.fromArray(imagePositions[0]);\n\n  const imagePosition2Vector = new external.cornerstoneMath.Vector3();\n\n  imagePosition2Vector.fromArray(imagePositions[1]);\n\n  const imageOrientationRowVector = new external.cornerstoneMath.Vector3();\n\n  imageOrientationRowVector.fromArray(imageOrientation[0]);\n\n  const imageOrientationColumnVector = new external.cornerstoneMath.Vector3();\n\n  imageOrientationColumnVector.fromArray(imageOrientation[1]);\n\n  // Compute unit normal of Image Orientation crossVectors\n  const orientationNormal = new external.cornerstoneMath.Vector3();\n\n  orientationNormal.crossVectors(imageOrientationRowVector, imageOrientationColumnVector);\n  // Project both position vectors on normal\n  const projection1 = imagePosition1Vector.projectOnVector(orientationNormal);\n  const projection2 = imagePosition2Vector.projectOnVector(orientationNormal);\n\n  // Compute distance of projected vectors\n  return projection1.distanceTo(projection2);\n}\n\nexport function computeOverlapFactor (distance, sliceThickness) {\n  if (distance <= 0) {\n    throw new Error('Distance must be > 0');\n  }\n\n  if (distance >= sliceThickness) {\n    return 1;\n  }\n\n  const overlap = sliceThickness - distance;\n\n  return (sliceThickness - overlap) / (sliceThickness);\n}\n\nfunction bfs (x, y, view, visitedVoxels, label, image) {\n  const { intercept, slope, width } = image;\n  const pixelData = image.getPixelData();\n  const lesionVoxels = [];\n  const stack = [[x, y]];\n\n  while (stack.length > 0) {\n    const [x, y] = stack.shift();\n\n    // If visited is 0, the element has not been visisted before\n    if (visitedVoxels[x][y] === 0 && view[y * width + x] === label) {\n      stack.push([x - 1, y]);\n      stack.push([x + 1, y]);\n      stack.push([x, y - 1]);\n      stack.push([x, y + 1]);\n\n      const value = pixelData[x + y * width];\n      const hu = (value * slope) + intercept;\n\n      if (hu >= 130) {\n        lesionVoxels.push(hu);\n      }\n      visitedVoxels[x][y] = 1;\n    }\n\n  }\n\n  return lesionVoxels;\n}\n\n/**\n * Calculate CaScore per label per slice per lesion\n *\n */\nexport function score (element) {\n  const { regionColorsRGB } = getConfiguration();\n\n  const regionsToolData = getToolState(element, TOOL_TYPE);\n  const stackToolData = getToolState(element, 'stack');\n  const { buffer } = regionsToolData.data[0];\n  const { imageIds } = stackToolData.data[0];\n\n  // Extract and group region-voxels\n  const voxelsEachRegion = regionColorsRGB.slice(1).map(() => imageIds.map(() => []));\n  const maxHUEachRegion = regionColorsRGB.slice(1).map(() => imageIds.map(() => []));\n\n  let overlapFactor;\n  let prevImagePosition;\n  const overlapFactors = [];\n\n  const metaData = {};\n\n  return Promise.all(imageIds.map((imageId, imageIndex) =>\n    external.cornerstone.loadImage(imageId).then((image) => {\n      const dataSet = image.data;\n\n      metaData.sliceThickness = dataSet.floatString('x00180050');\n      metaData.pixelSpacing = dataSet.string('x00280030').split('\\\\').map(parseFloat);\n      metaData.KVP = dataSet.floatString('x00180060');\n      metaData.rescaleSlope = dataSet.floatString('x00281053');\n      metaData.rescaleIntercept = dataSet.floatString('x00281052');\n      metaData.rescaleType = dataSet.string('x00281054');\n\n      const imagePositionPatient = dataSet.string('x00200032').split('\\\\').map(parseFloat);\n      const imageOrientationTmp = dataSet.string('x00200037').split('\\\\').map(parseFloat);\n      const imageOrientation = [\n        imageOrientationTmp.slice(0, 3),\n        imageOrientationTmp.slice(3)\n      ];\n\n      /* What is this?\n       if (metaData.rescaleType !== 'HU') {\n         console.warn(`Modality LUT does not convert to Hounsfield units but to ${metaData.rescaleType}. Agatston score is not defined for this unit type.`);\n\n         return;\n      }\n       */\n\n      if (prevImagePosition) {\n        const distance = computeIOPProjectedDistance([prevImagePosition, imagePositionPatient], imageOrientation);\n\n        overlapFactor = computeOverlapFactor(distance, metaData.sliceThickness);\n\n        // Find overlapfactor with the highest occurance\n        overlapFactors.push(overlapFactor);\n        metaData.modeOverlapFactor = mode(overlapFactors);\n\n        // Save imagePositionPatient for next overlapFactor computation\n        prevImagePosition = imagePositionPatient;\n      } else {\n        prevImagePosition = imagePositionPatient;\n      }\n\n      // Overlap has been calculated, now we investigate voxels\n\n      const { height, width } = image;\n      const sliceSize = width * height;\n      const offset = imageIndex * sliceSize;\n\n      const view = new TYPED_ARRAY(buffer, offset, sliceSize);\n\n      // Initialze with 0's\n      const visitedVoxels = Array(width).fill().map(() => Array(height).fill(0));\n\n      for (let x = 0; x < width; x += 1) {\n        for (let y = 0; y < height; y += 1) {\n          // Extract label from view into ArrayBuffer\n          const label = view[y * width + x];\n\n          if (label > 1) {\n            const lesionVoxels = bfs(x, y, view, visitedVoxels, label, image);\n\n            if (lesionVoxels.length) {\n              const maxHU = Math.max(...lesionVoxels);\n\n              voxelsEachRegion[label - 2][imageIndex].push(lesionVoxels);\n              maxHUEachRegion[label - 2][imageIndex].push(maxHU);\n            }\n          }\n        }\n      }\n    })\n  // When all images have been processed\n  )).then(() => voxelsEachRegion.map((slicesInLabel, labelIdx) => {\n    const cascore = [];\n\n    slicesInLabel.forEach((lesions, sliceIdx) => {\n      lesions.forEach((voxels, lesionIdx) => {\n        metaData.maxHU = maxHUEachRegion[labelIdx][sliceIdx][lesionIdx];\n\n        const cascoreCurrent = voxels.length > 0 ? computeScore(metaData, voxels) : 0;\n\n        cascore.push(cascoreCurrent);\n      });\n    });\n    const sum = cascore.reduce((acc, val) => acc + val, 0);\n\n    return sum;\n  }));\n}\n\nexport default score;\n\n\n\n// WEBPACK FOOTER //\n// ./lesionTools/score.js"],"sourceRoot":""}