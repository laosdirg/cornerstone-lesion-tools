{"version":3,"sources":["webpack:///webpack/universalModuleDefinition","webpack:///webpack/bootstrap 8e2da0537bc5b1b7d4a1","webpack:///./externalModules.js","webpack:///./configuration.js","webpack:///./constants.js","webpack:///./lesionTools/history.js","webpack:///./index.js","webpack:///./lesionTools/display.js","webpack:///./lesionTools/threshold.js","webpack:///./lesionTools/grow.js","webpack:///./lesionTools/draw.js","webpack:///./util/pointInsidePolygon.js","webpack:///./lesionTools/score.js"],"names":["cornerstoneTools","window","cst","cornerstone","external","cornerstoneMath","getConfiguration","setConfiguration","configuration","snap","historySize","layersAbove","layersBelow","historyPosition","toolRegionValue","calciumThresholdHu","drawAlpha","regionColorsRGB","KVPToMultiplier","growIterationsPerChunk","calciumThresholdHuParsed","parseInt","config","TYPED_ARRAY","Uint8Array","TOOL_TYPE","createUndoStep","undo","redo","getToolState","element","thresholdingData","state","data","current","buffer","slice","history","push","length","shift","replacement","pop","updateImage","default","displayTool","addToolState","toolType","onImageRendered","detail","canvasContext","enabledElement","image","width","height","stackToolData","regionsToolData","displayToolData","displayData","canvas","imageData","document","createElement","context","getContext","createImageData","currentImageIdIndex","doubleBuffer","pixels","sliceSize","sliceOffset","view","offset","imageDataOffset","label","color","putImageData","setToPixelCoordinateSystem","drawImage","lesionIndicator","performThresholding","imageIds","Promise","all","map","imageId","imageIdIndex","loadImage","then","ArrayBuffer","intercept","slope","pixelData","getPixelData","i","value","hu","ensureToolData","regionsData","enabled","drawBuffer","threshold","stackData","regions","simpleMouseButtonTool","isMouseButtonEnabled","getToolOptions","linearNeighbours","highSlice","lowSlice","index","neighbours","sliceIndex","Math","floor","regionGrowing","point","x","y","clickIndex","linearIndex","fromValue","resolve","activeVoxels","chunk","forEach","nextVoxels","reduce","acc","cur","concat","filter","self","indexOf","setTimeout","mouseDownCallback","e","currentPoints","which","options","mouseButtonMask","round","toolColors","setToolOptions","updateRegions","numSlices","startSlice","max","endSlice","min","dslice","prevValue","snapBool","points","imageRenderedCallback","fillStyle","getFillColor","strokeStyle","getActiveColor","beginPath","moveTo","lineTo","closePath","stroke","fill","dragCallback","preventDefault","stopPropagation","mouseUpCallback","removeEventListener","addEventListener","pointInsidePolygon","polygon","n","inside","j","xi","yi","xj","yj","intersect","computeVoxelSize","computeScore","computeIOPProjectedDistance","computeOverlapFactor","score","getDensityFactor","mode","array","modeMap","maxEl","maxCount","el","metaData","sliceThickness","pixelSpacing","Error","zLength","xLength","yLength","voxels","voxelSizeScaled","densityFactor","maxHU","volume","KVPMultiplier","KVP","cascore","modeOverlapFactor","imagePositions","imageOrientation","imagePosition1Vector","Vector3","fromArray","imagePosition2Vector","imageOrientationRowVector","imageOrientationColumnVector","orientationNormal","crossVectors","projection1","projectOnVector","projection2","distanceTo","distance","overlap","bfs","visitedVoxels","lesionVoxels","stack","voxelsEachRegion","maxHUEachRegion","overlapFactor","prevImagePosition","overlapFactors","imageIndex","imagePlane","get","modalityLut","rescaleSlope","rescaleIntercept","rescaleType","imagePositionPatient","imageOrientationTmp","imageOrientationPatient","dataSet","floatString","Array","slicesInLabel","labelIdx","lesions","sliceIdx","lesionIdx","cascoreCurrent","sum","val"],"mappings":"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","file":"cornerstoneLesionTools.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine(\"cornerstoneLesionTools\", [], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"cornerstoneLesionTools\"] = factory();\n\telse\n\t\troot[\"cornerstoneLesionTools\"] = factory();\n})(typeof self !== 'undefined' ? self : this, function() {\nreturn \n\n\n// WEBPACK FOOTER //\n// webpack/universalModuleDefinition"," \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 4);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 8e2da0537bc5b1b7d4a1","let cornerstoneTools = window.cornerstoneTools;\n\nexport default {\n  set cornerstoneTools (cst) {\n    cornerstoneTools = cst;\n  },\n  get cornerstoneTools () {\n    return cornerstoneTools;\n  },\n  get cornerstone () {\n    return cornerstoneTools.external.cornerstone;\n  },\n  get cornerstoneMath () {\n    return cornerstoneTools.external.cornerstoneMath;\n  }\n};\n\n\n\n// WEBPACK FOOTER //\n// ./externalModules.js","let configuration = {\n  snap: false, // Snap to thresholded region or not\n  historySize: 4,\n  layersAbove: 1,\n  layersBelow: 1,\n  historyPosition: 0,\n  toolRegionValue: 2,\n  calciumThresholdHu: '-', // Placeholder until it gets set ('-' shows up nicely in text input)\n  drawAlpha: 1,\n  regionColorsRGB: [\n    [255, 0, 255],\n    [246, 193, 91],\n    [237, 148, 69],\n    [230, 103, 49],\n    [184, 74, 41],\n    [106, 58, 45]\n  ],\n  KVPToMultiplier: {\n    150: 1.06,\n    140: 1.04,\n    130: 1.02,\n    120: 1,\n    110: 0.98,\n    100: 0.96,\n    90: 0.93,\n    80: 0.89,\n    70: 0.85\n  },\n  growIterationsPerChunk: 2\n};\n\nconfiguration.calciumThresholdHuParsed = parseInt(configuration.calciumThresholdHu, 10);\n\nexport function getConfiguration () {\n  return configuration;\n}\n\nexport function setConfiguration (config) {\n  configuration = config;\n}\n\n\n\n// WEBPACK FOOTER //\n// ./configuration.js","export const TYPED_ARRAY = Uint8Array;\nexport const TOOL_TYPE = 'regions';\n\n\n\n// WEBPACK FOOTER //\n// ./constants.js","import external from '../externalModules.js';\nimport { getConfiguration } from '../configuration.js';\n\nconst { getToolState } = external.cornerstoneTools;\n\n/**\n * Store current state to history\n */\nexport function createUndoStep (element) {\n  const thresholdingData = getToolState(element, 'regions');\n\n  const state = thresholdingData.data[0];\n  // Make a copy using .slice()\n  const current = state.buffer.slice();\n\n  // Put at end of history\n  state.history.push(current);\n  // Remove oldest if too much history\n  if (state.history.length > getConfiguration().historySize) {\n    state.history.shift();\n  }\n}\n\nexport function undo (element) {\n  const thresholdingData = getToolState(element, 'regions');\n  const state = thresholdingData.data[0];\n\n  if (state.history.length < 1) {\n    return;\n  }\n\n  const replacement = state.history.pop();\n\n  state.buffer = replacement;\n  external.cornerstone.updateImage(element);\n}\n\nexport function redo () {\n  // Not implemented\n}\n\n\n\n// WEBPACK FOOTER //\n// ./lesionTools/history.js","export { default as external } from './externalModules.js';\nexport { getConfiguration, setConfiguration } from './configuration.js';\n\nexport { default as display } from './lesionTools/display.js';\nexport { default as threshold } from './lesionTools/threshold.js';\nexport { default as grow } from './lesionTools/grow.js';\nexport { default as draw } from './lesionTools/draw.js';\nexport { default as score } from './lesionTools/score.js';\nexport { undo, redo } from './lesionTools/history.js';\n\n\n\n// WEBPACK FOOTER //\n// ./index.js","import external from '../externalModules.js';\nimport { TYPED_ARRAY } from '../constants.js';\nimport { getConfiguration } from '../configuration.js';\n\nconst { displayTool, addToolState, getToolState } = external.cornerstoneTools;\n\nconst toolType = 'lesionDisplay';\n\n/**\n * Draw regions on image\n */\nfunction onImageRendered ({ detail }) {\n  const configuration = getConfiguration();\n  const { canvasContext, element, enabledElement, image } = detail;\n  const { width, height } = image;\n\n  const stackToolData = getToolState(element, 'stack');\n  const regionsToolData = getToolState(element, 'regions');\n  const displayToolData = getToolState(element, toolType);\n\n  // Ensure tool is enabled\n  if (!regionsToolData || !regionsToolData.data || !regionsToolData.data.length) {\n    return;\n  }\n\n  let displayData;\n\n  if (!displayToolData || !displayToolData.data || !displayToolData.data.length) {\n    displayData = {\n      canvas: null,\n      imageData: null\n    };\n    addToolState(element, toolType, displayData);\n  } else {\n    displayData = displayToolData.data[0];\n  }\n\n  if (!displayData.canvas || width !== displayToolData.canvas.width) {\n    const canvas = document.createElement('canvas');\n    const context = canvas.getContext('2d');\n    const imageData = context.createImageData(width, height);\n\n    canvas.width = width;\n    canvas.height = height;\n\n    displayData = {\n      canvas,\n      imageData\n    };\n  }\n\n  // Extract tool data\n  const { currentImageIdIndex } = stackToolData.data[0];\n  const { buffer } = regionsToolData.data[0];\n\n  const doubleBuffer = displayData.canvas;\n  const imageData = displayData.imageData;\n\n  const pixels = imageData.data;\n  const sliceSize = width * height;\n  const sliceOffset = currentImageIdIndex * sliceSize;\n  const view = new TYPED_ARRAY(buffer, sliceOffset, sliceSize);\n\n  for (let offset = 0; offset < view.length; offset += 1) {\n    // Each pixel is represented by four elements in the imageData array\n    const imageDataOffset = offset * 4;\n    const label = view[offset];\n\n    if (label) {\n      const color = configuration.regionColorsRGB[label - 1];\n\n      pixels[imageDataOffset + 0] = color[0];\n      pixels[imageDataOffset + 1] = color[1];\n      pixels[imageDataOffset + 2] = color[2];\n      pixels[imageDataOffset + 3] = configuration.drawAlpha * 255;\n    } else {\n      pixels[imageDataOffset + 3] = 0;\n    }\n  }\n\n  // Put image data back into offscreen canvas\n  doubleBuffer.getContext('2d').putImageData(imageData, 0, 0);\n  // Set transforms based on zoom/pan/etc\n  external.cornerstone.setToPixelCoordinateSystem(enabledElement, canvasContext);\n  // Finally, draw offscreen canvas onto context\n  canvasContext.drawImage(doubleBuffer, 0, 0);\n}\n\nconst lesionIndicator = displayTool(onImageRendered);\n\nexport default lesionIndicator;\n\n\n\n// WEBPACK FOOTER //\n// ./lesionTools/display.js","import external from '../externalModules.js';\nimport { TYPED_ARRAY, TOOL_TYPE } from '../constants.js';\nimport { getConfiguration } from '../configuration.js';\n\nconst { addToolState, getToolState } = external.cornerstoneTools;\n\n/**\n * Perform the thresholding on a stack\n */\nfunction performThresholding (imageIds) {\n  let width, height, view, buffer;\n\n  const configuration = getConfiguration();\n\n  // Thresholding promises\n  return Promise.all(imageIds.map((imageId, imageIdIndex) =>\n    external.cornerstone.loadImage(imageId).then((image) => {\n      if (!buffer) {\n        // Initialize variables on first loaded image\n        width = image.width;\n        height = image.height;\n\n        const length = width * height * imageIds.length;\n\n        buffer = new ArrayBuffer(length);\n        view = new TYPED_ARRAY(buffer);\n      }\n\n      const { intercept, slope } = image;\n      const pixelData = image.getPixelData();\n      const sliceSize = width * height;\n\n      for (let i = 0; i < sliceSize; i++) {\n        const value = pixelData[i];\n        // Calculate hu-value\n        const hu = (value * slope) + intercept;\n        // Check against threshold\n        const label = (hu >= configuration.calciumThresholdHu) ? 1 : 0;\n        // Calculate offset within view into ArrayBufer\n        const offset = imageIdIndex * sliceSize + i;\n\n        // Finally, assign label\n        view[offset] = label;\n      }\n    })\n  // When all promises resolve, return the buffer and its dimensions\n  )).then(() => ({\n    buffer,\n    width,\n    height\n  }));\n}\n\nfunction ensureToolData (element) {\n  let regionsData;\n\n  const regionsToolData = getToolState(element, TOOL_TYPE);\n\n  if (!regionsToolData || !regionsToolData.data || !regionsToolData.data.length) {\n    regionsData = {\n      enabled: 1,\n      buffer: null,\n      width: null,\n      height: null,\n      history: [],\n      drawBuffer: null\n    };\n    addToolState(element, TOOL_TYPE, regionsData);\n  } else {\n    regionsData = regionsToolData.data[0];\n  }\n\n  return regionsData;\n}\n\nfunction threshold (element) {\n  const stackToolData = getToolState(element, 'stack');\n\n  if (!stackToolData || !stackToolData.data || !stackToolData.data.length) {\n    return;\n  }\n\n  const stackData = stackToolData.data[0];\n  const regionsData = ensureToolData(element);\n\n  performThresholding(stackData.imageIds).then((regions) => {\n    // Add threshold data to tool state\n    regionsData.buffer = regions.buffer;\n    regionsData.width = regions.width;\n    regionsData.height = regions.height;\n\n    // Update the element to apply the viewport and tool changes\n    external.cornerstone.updateImage(element);\n  });\n}\n// Module/private exports\nexport default threshold;\n\n\n\n// WEBPACK FOOTER //\n// ./lesionTools/threshold.js","import external from '../externalModules.js';\nimport { createUndoStep } from './history.js';\nimport { getConfiguration } from '../configuration.js';\n\nconst {\n  getToolState,\n  simpleMouseButtonTool,\n  isMouseButtonEnabled,\n  getToolOptions\n} = external.cornerstoneTools;\n\nconst toolType = 'regionsGrow';\n\n// Get neighbour linear indices within slice bounds\nfunction linearNeighbours (width, height, highSlice, lowSlice, index) {\n  const sliceSize = width * height;\n  const neighbours = [\n    index - 1,\n    index + 1,\n    index - width,\n    index + width\n  ];\n\n  // Stay within bounds\n  const sliceIndex = Math.floor(index / sliceSize);\n\n  if (sliceIndex < highSlice) {\n    neighbours.push(index + sliceSize);\n  }\n  if (sliceIndex > lowSlice) {\n    neighbours.push(index - sliceSize);\n  }\n\n  return neighbours;\n}\n\nfunction regionGrowing (regions, point) {\n  const { growIterationsPerChunk, toolRegionValue, layersAbove, layersBelow } = getConfiguration();\n  const { width, height, buffer } = regions;\n  const [x, y, slice] = point;\n  const highSlice = slice + layersBelow;\n  const lowSlice = slice - layersAbove;\n\n  const view = new Uint8Array(buffer);\n\n  // Calculate linear indices and offsets\n  const sliceSize = width * height;\n  const sliceOffset = sliceSize * slice;\n  const clickIndex = (y * width) + x;\n  const linearIndex = sliceOffset + clickIndex;\n  const fromValue = view[linearIndex];\n\n  // Only continue if we clicked in thresholded area in different color\n  if (fromValue === 0 || fromValue === toolRegionValue) {\n    return Promise.resolve();\n  }\n\n  // Growing starts at clicked voxel\n  let activeVoxels = [linearIndex];\n\n  return new Promise((resolve) => {\n    function chunk () {\n      for(let i = 0; i < growIterationsPerChunk; i++) {\n        // While activeVoxels is not empty\n        if (activeVoxels.length === 0) {\n          return resolve();\n        }\n\n        // Set the active voxels to nextValue\n        activeVoxels.forEach((i) => {\n          view[i] = toolRegionValue;\n        });\n\n        // The new active voxels are neighbours of curent active voxels\n        const nextVoxels = activeVoxels.map(\n          (i) => linearNeighbours(width, height, highSlice, lowSlice, i)\n        ).reduce( // Flatten the array of arrays to array of indices\n          (acc, cur) => acc.concat(cur), []\n        ).filter( // Remove duplicates\n          (value, index, self) => self.indexOf(value) === index\n        ).filter( // Remove voxels that does not have the correct fromValue\n          (i) => view[i] === fromValue\n        );\n\n        activeVoxels = nextVoxels;\n      }\n      setTimeout(chunk, 0);\n    }\n\n    chunk();\n  });\n}\n\nfunction mouseDownCallback (e) {\n  const { currentPoints, element, which } = e.detail;\n  const options = getToolOptions(toolType, element);\n\n  if (isMouseButtonEnabled(which, options.mouseButtonMask)) {\n    const [stackData] = getToolState(element, 'stack').data;\n    const [regionsData] = getToolState(element, 'regions').data;\n    const { currentImageIdIndex } = stackData;\n    const { x, y } = currentPoints.image;\n    const point = [Math.round(x), Math.round(y), currentImageIdIndex];\n\n    createUndoStep(element);\n    regionGrowing(regionsData, point).then(() => {\n      external.cornerstone.updateImage(element);\n    });\n  }\n}\n\nexport default simpleMouseButtonTool(mouseDownCallback, toolType);\n\n\n\n// WEBPACK FOOTER //\n// ./lesionTools/grow.js","import external from '../externalModules.js';\nimport pointInsidePolygon from '../util/pointInsidePolygon.js';\nimport { getConfiguration } from '../configuration.js';\n\nimport { createUndoStep } from './history.js';\n\nconst { toolColors, getToolState, getToolOptions, setToolOptions, simpleMouseButtonTool, isMouseButtonEnabled } = external.cornerstoneTools;\n\nconst toolType = 'lesionDraw';\n\nfunction updateRegions (element) {\n  const { snap, toolRegionValue, layersAbove, layersBelow } = getConfiguration();\n\n  createUndoStep(element);\n\n  // Get tool data\n  const stackData = getToolState(element, 'stack');\n  const thresholdingData = getToolState(element, 'regions');\n  const options = getToolOptions(toolType, element);\n\n  // Extract tool data\n  const slice = stackData.data[0].currentImageIdIndex;\n  const numSlices = stackData.data[0].imageIds.length;\n  const regions = thresholdingData.data[0];\n\n  // Extract region data\n  const buffer = regions.buffer;\n  const width = regions.width;\n  const height = regions.height;\n\n  // Find operation bounds\n  const startSlice = Math.max(0, slice - layersAbove);\n  const endSlice = Math.min(numSlices, slice + layersBelow);\n\n  // Setup view into buffer\n  const sliceSize = width * height;\n  const sliceOffset = startSlice * sliceSize;\n  const view = new Uint8Array(buffer, sliceOffset);\n\n  // Mark points inside\n  for (let dslice = 0; dslice <= endSlice - startSlice; dslice += 1) {\n    for (let x = 0; x < width; x += 1) {\n      for (let y = 0; y < height; y += 1) {\n        const index = x + (y * width) + (dslice * sliceSize);\n        const prevValue = view[index];\n\n        let snapBool;\n\n        if (snap) {\n          snapBool = prevValue > 0;\n        } else {\n          snapBool = true;\n        }\n        const point = {\n          x,\n          y\n        };\n\n        if (snapBool && pointInsidePolygon(point, options.points)) {\n          view[index] = toolRegionValue;\n        }\n      }\n    }\n  }\n}\n\n// Draw regions on the canvas\nfunction imageRenderedCallback (e) {\n  const { canvasContext, enabledElement, element } = e.detail;\n\n  // Points\n  const options = getToolOptions(toolType, element);\n  const points = options.points;\n\n  if (points.length < 2) {\n    return;\n  }\n\n  // Set the canvas context to the image coordinate system\n  external.cornerstone.setToPixelCoordinateSystem(enabledElement, canvasContext);\n\n  canvasContext.fillStyle = toolColors.getFillColor();\n  canvasContext.strokeStyle = toolColors.getActiveColor();\n  canvasContext.beginPath();\n  canvasContext.moveTo(points[0].x, points[0].y);\n  points.slice(1).forEach(function (point) {\n    canvasContext.lineTo(point.x, point.y);\n  });\n  canvasContext.closePath();\n  canvasContext.stroke();\n  canvasContext.fill();\n}\n\nfunction dragCallback (e) {\n  const { currentPoints, element } = e.detail;\n  const options = getToolOptions(toolType, element);\n\n  options.points.push(currentPoints.image);\n  external.cornerstone.updateImage(element);\n\n  e.preventDefault();\n  e.stopPropagation();\n}\n\n// Disable drawing and tracking on mouse up also update regions\nfunction mouseUpCallback (e) {\n  const { element } = e.detail;\n\n  element.removeEventListener('cornerstonetoolsmousedrag', dragCallback);\n  element.removeEventListener('cornerstonetoolsmouseup', mouseUpCallback);\n  element.removeEventListener('cornerstonetoolsmouseclick', mouseUpCallback);\n  element.removeEventListener('cornerstoneimagerendered', imageRenderedCallback);\n\n  updateRegions(element);\n  external.cornerstone.updateImage(element);\n}\n\n// Start drawing and tracking on mouse up, also reset points array\nfunction mouseDownCallback (e) {\n  const { element, which } = e.detail;\n  const options = getToolOptions(toolType, element);\n\n  if (isMouseButtonEnabled(which, options.mouseButtonMask)) {\n    options.points = [];\n\n    setToolOptions(toolType, element, options);\n\n    element.addEventListener('cornerstonetoolsmousedrag', dragCallback);\n    element.addEventListener('cornerstonetoolsmouseup', mouseUpCallback);\n    element.addEventListener('cornerstonetoolsmouseclick', mouseUpCallback);\n    element.addEventListener('cornerstoneimagerendered', imageRenderedCallback);\n\n    e.preventDefault();\n    e.stopPropagation();\n  }\n}\n\nexport default simpleMouseButtonTool(mouseDownCallback, toolType);\n\n\n\n// WEBPACK FOOTER //\n// ./lesionTools/draw.js","// Determine if a point is inside a polygon\nexport default function pointInsidePolygon (point, polygon) {\n  const { x, y } = point;\n  const n = polygon.length;\n  let inside = false;\n\n  for (let i = 0, j = n - 1; i < n; j = i++) {\n    const { x: xi, y: yi } = polygon[i];\n    const { x: xj, y: yj } = polygon[j];\n\n    const intersect = ((yi > y) !== (yj > y)) &&\n      (x < (xj - xi) * (y - yi) / (yj - yi) + xi);\n\n    if (intersect) {\n      inside = !inside;\n    }\n  }\n\n  return inside;\n}\n\n\n\n// WEBPACK FOOTER //\n// ./util/pointInsidePolygon.js","import external from '../externalModules.js';\nimport { getConfiguration } from '../configuration.js';\nimport { TYPED_ARRAY, TOOL_TYPE } from '../constants.js';\n\nconst { getToolState } = external.cornerstoneTools;\n\nfunction getDensityFactor (hu) {\n  if (hu < 130) {\n    return 0;\n  } else if (hu < 200) {\n    return 1;\n  } else if (hu < 300) {\n    return 2;\n  } else if (hu < 400) {\n    return 3;\n  }\n\n  return 4;\n}\n\n// Finds the value with the most occurrences in array\n// Should be O(n)\nfunction mode (array) {\n  if (array.length === 0) {\n    return null;\n  }\n  const modeMap = {};\n  let maxEl = array[0];\n  let maxCount = 1;\n\n  for (let i = 0; i < array.length; i++) {\n    const el = array[i];\n\n    if (modeMap[el] === null) {\n      modeMap[el] = 1;\n    } else {\n      modeMap[el]++;\n    }\n\n    if(modeMap[el] > maxCount) {\n      maxEl = el;\n      maxCount = modeMap[el];\n    }\n  }\n\n  return maxEl;\n}\n\nexport function computeVoxelSize (metaData) {\n  if (metaData.sliceThickness === 0 ||\n      metaData.pixelSpacing[0] === 0 ||\n      metaData.pixelSpacing[1] === 0) {\n    throw new Error('sliceThickness or pixelSpacing was 0');\n  }\n  const zLength = metaData.sliceThickness;\n  const xLength = metaData.pixelSpacing[0];\n  const yLength = metaData.pixelSpacing[1];\n\n\n  return zLength * xLength * yLength; // In mm³\n}\n\nexport function computeScore (metaData, voxels) {\n  // Division by 3 because Agatson score assumes a slice thickness of 3 mm\n  const voxelSizeScaled = computeVoxelSize(metaData) / 3;\n  const densityFactor = getDensityFactor(metaData.maxHU);\n  const volume = voxels.length * voxelSizeScaled;\n\n  const { KVPToMultiplier } = getConfiguration();\n  const KVPMultiplier = KVPToMultiplier[metaData.KVP];\n  const cascore = volume * densityFactor * KVPMultiplier;\n\n /*\n  console.log(`modeOverlapFactor: ${metaData.modeOverlapFactor}`);\n  console.log(`voxels.length: ${voxels.length}`);\n  console.log(`voxelSizeScaled: ${voxelSizeScaled}`);\n  console.log(`Volume: ${volume}`);\n  console.log(`Max HU: ${metaData.maxHU}`);\n  console.log(`densityFactor: ${densityFactor}`);\n  console.log(`KVPMultiplier: ${KVPMultiplier}`);\n  console.log(`CAscore: ${cascore}`); */\n\n  // If modeOverlapFactor factor is undefined it is because there is only one slice in the series.\n  // In this case obviously modeOverlapFactor is meaningless and should not be multiplied with cascore.\n  if (metaData.modeOverlapFactor) {\n    return cascore * metaData.modeOverlapFactor;\n  }\n\n  return cascore;\n\n}\n\n/*\n* Computes the distance between two slices based on the DICOM Image Plane Module\n* @param imagePositions {Array[2][3]} - DICOM tag (0020, 0032) of two slices\n* @param imageOrientation {Array[2][3]} - DICOM tag (0020, 0037) of first slice\n*/\nexport function computeIOPProjectedDistance (imagePositions, imageOrientation) {\n  const imagePosition1Vector = new external.cornerstoneMath.Vector3();\n\n  imagePosition1Vector.fromArray(imagePositions[0]);\n\n  const imagePosition2Vector = new external.cornerstoneMath.Vector3();\n\n  imagePosition2Vector.fromArray(imagePositions[1]);\n\n  const imageOrientationRowVector = new external.cornerstoneMath.Vector3();\n\n  imageOrientationRowVector.fromArray(imageOrientation[0]);\n\n  const imageOrientationColumnVector = new external.cornerstoneMath.Vector3();\n\n  imageOrientationColumnVector.fromArray(imageOrientation[1]);\n\n  // Compute unit normal of Image Orientation crossVectors\n  const orientationNormal = new external.cornerstoneMath.Vector3();\n\n  orientationNormal.crossVectors(imageOrientationRowVector, imageOrientationColumnVector);\n  // Project both position vectors on normal\n  const projection1 = imagePosition1Vector.projectOnVector(orientationNormal);\n  const projection2 = imagePosition2Vector.projectOnVector(orientationNormal);\n\n  // Compute distance of projected vectors\n  return projection1.distanceTo(projection2);\n}\n\nexport function computeOverlapFactor (distance, sliceThickness) {\n  if (distance <= 0) {\n    throw new Error('Distance must be > 0');\n  }\n\n  if (distance >= sliceThickness) {\n    return 1;\n  }\n\n  const overlap = sliceThickness - distance;\n\n  return (sliceThickness - overlap) / (sliceThickness);\n}\n\nfunction bfs (x, y, view, visitedVoxels, label, image) {\n  const { intercept, slope, width } = image;\n  const pixelData = image.getPixelData();\n  const lesionVoxels = [];\n  const stack = [[x, y]];\n\n  while (stack.length > 0) {\n    const [x, y] = stack.shift();\n\n    // If visited is 0, the element has not been visisted before\n    if (visitedVoxels[x][y] === 0 && view[y * width + x] === label) {\n      stack.push([x - 1, y]);\n      stack.push([x + 1, y]);\n      stack.push([x, y - 1]);\n      stack.push([x, y + 1]);\n\n      const value = pixelData[x + y * width];\n      const hu = (value * slope) + intercept;\n\n      if (hu >= 130) {\n        lesionVoxels.push(hu);\n      }\n      visitedVoxels[x][y] = 1;\n    }\n\n  }\n\n  return lesionVoxels;\n}\n\n/**\n * Calculate CaScore per label per slice per lesion\n *\n */\nexport function score (element) {\n  const { regionColorsRGB } = getConfiguration();\n\n  const regionsToolData = getToolState(element, TOOL_TYPE);\n  const stackToolData = getToolState(element, 'stack');\n  const { buffer } = regionsToolData.data[0];\n  const { imageIds } = stackToolData.data[0];\n\n  // Extract and group region-voxels\n  const voxelsEachRegion = regionColorsRGB.slice(1).map(() => imageIds.map(() => []));\n  const maxHUEachRegion = regionColorsRGB.slice(1).map(() => imageIds.map(() => []));\n\n  let overlapFactor;\n  let prevImagePosition;\n  const overlapFactors = [];\n\n  const metaData = {};\n\n  return Promise.all(imageIds.map((imageId, imageIndex) =>\n    external.cornerstone.loadImage(imageId).then((image) => {\n\n      const imagePlane = external.cornerstone.metaData.get('imagePlaneModule', imageId);\n      const modalityLut = external.cornerstone.metaData.get('modalityLutModule', imageId);\n\n      metaData.sliceThickness = imagePlane.sliceThickness;\n      metaData.pixelSpacing = imagePlane.pixelSpacing;\n      metaData.rescaleSlope = modalityLut.rescaleSlope;\n      metaData.rescaleIntercept = modalityLut.rescaleIntercept;\n      metaData.rescaleType = modalityLut.rescaleType;\n\n      const imagePositionPatient = imagePlane.imagePositionPatient;\n      const imageOrientationTmp = imagePlane.imageOrientationPatient;\n      const imageOrientation = [\n        imageOrientationTmp.slice(0, 3),\n        imageOrientationTmp.slice(3)\n      ];\n\n      const dataSet = image.data;\n      metaData.KVP = dataSet.floatString('x00180060');\n      /* What is this?\n       if (metaData.rescaleType !== 'HU') {\n         console.warn(`Modality LUT does not convert to Hounsfield units but to ${metaData.rescaleType}. Agatston score is not defined for this unit type.`);\n\n         return;\n      }\n       */\n\n      if (prevImagePosition) {\n        const distance = computeIOPProjectedDistance([prevImagePosition, imagePositionPatient], imageOrientation);\n\n        overlapFactor = computeOverlapFactor(distance, metaData.sliceThickness);\n\n        // Find overlapfactor with the highest occurance\n        overlapFactors.push(overlapFactor);\n        metaData.modeOverlapFactor = mode(overlapFactors);\n\n        // Save imagePositionPatient for next overlapFactor computation\n        prevImagePosition = imagePositionPatient;\n      } else {\n        prevImagePosition = imagePositionPatient;\n      }\n\n      // Overlap has been calculated, now we investigate voxels\n\n      const { height, width } = image;\n      const sliceSize = width * height;\n      const offset = imageIndex * sliceSize;\n\n      const view = new TYPED_ARRAY(buffer, offset, sliceSize);\n\n      // Initialze with 0's\n      const visitedVoxels = Array(width).fill().map(() => Array(height).fill(0));\n\n      for (let x = 0; x < width; x += 1) {\n        for (let y = 0; y < height; y += 1) {\n          // Extract label from view into ArrayBuffer\n          const label = view[y * width + x];\n\n          if (label > 1) {\n            const lesionVoxels = bfs(x, y, view, visitedVoxels, label, image);\n\n            if (lesionVoxels.length) {\n              const maxHU = Math.max(...lesionVoxels);\n\n              voxelsEachRegion[label - 2][imageIndex].push(lesionVoxels);\n              maxHUEachRegion[label - 2][imageIndex].push(maxHU);\n            }\n          }\n        }\n      }\n    })\n  // When all images have been processed\n  )).then(() => voxelsEachRegion.map((slicesInLabel, labelIdx) => {\n    const cascore = [];\n\n    slicesInLabel.forEach((lesions, sliceIdx) => {\n      lesions.forEach((voxels, lesionIdx) => {\n        metaData.maxHU = maxHUEachRegion[labelIdx][sliceIdx][lesionIdx];\n\n        const cascoreCurrent = voxels.length > 0 ? computeScore(metaData, voxels) : 0;\n\n        cascore.push(cascoreCurrent);\n      });\n    });\n    const sum = cascore.reduce((acc, val) => acc + val, 0);\n\n    return sum;\n  }));\n}\n\nexport default score;\n\n\n\n// WEBPACK FOOTER //\n// ./lesionTools/score.js"],"sourceRoot":""}